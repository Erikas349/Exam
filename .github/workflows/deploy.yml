name: CI/CD to EC2

on:
  push:
    branches: [main]

env:
  DOCKER_BUILDKIT: 1

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up SSH
      run: |
        SSH_DIR="$HOME/.ssh"
        mkdir -p "$SSH_DIR"
        echo "${{ secrets.EC2_SSH_KEY }}" > "$SSH_DIR/id_rsa"
        chmod 600 "$SSH_DIR/id_rsa"
        ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> "$SSH_DIR/known_hosts"
         ls -la "$SSH_DIR" && head -n 3 "$SSH_DIR/id_rsa"
          
    - name: List SSH files
      run: ls -la $SSH_DIR

    - name: Deploy to EC2
      run: |
        ssh -i "$HOME/.ssh/id_rsa" \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile="$HOME/.ssh/known_hosts" \
          -p ${{ secrets.EC2_PORT }} \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          echo "ðŸ“¦ Installing git and docker..."
          sudo yum update -y
          sudo yum install -y git docker
          sudo systemctl start docker
          sudo systemctl enable docker
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          echo "ðŸ” Pulling latest code..."
          cd ~/Exam/To-Do-app || git clone https://github.com/Erikas349/Exam.git ~/Exam && cd ~/Exam/To-Do-app
          git pull origin main
          echo "ðŸ”„ Rebuilding Docker containers..."
          docker-compose down --remove-orphans
          docker-compose up --build -d
          echo "ðŸ§¹ Cleaning up..."
          docker system prune -af --volumes
          echo "âœ… Deployment done!"
        EOF
    - name: Test SSH access
      run: |
        ssh -i "$HOME/.ssh/id_rsa" \
          -o StrictHostKeyChecking=no \
          -o UserKnownHostsFile="$HOME/.ssh/known_hosts" \
          -p ${{ secrets.EC2_PORT }} \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        echo "âœ… SSH is working from GitHub Actions!"
        uname -a
        EOF